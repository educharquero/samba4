# Construindo um Controlador de Domínio Primário com Samb4 no Debian Linux 12

# 

#### Layout de rede usado no laboratório:

```bash
firewall           192.168.70.254 - 192.168.122.254
dc01               192.168.70.250   (ssh 22250)
dc02               192.168.70.200   (ssh 22200)
fileserver         192.168.70.150   (ssh 22100)

firewall           Roteamento por Iptables
dc01               Controlador de Domínio primário
dc02               Controlador de Domínio secundário
fileserver         Servidor de Arquivos
```

#### Instalando as dependências para compilação do código fonte  do Samba4:

```bash
export DEBIAN_FRONTEND=noninteractive;apt-get update; apt-get install vim ntp net-tools rsync acl apt-utils attr autoconf bind9utils binutils bison build-essential ccache chrpath curl debhelper dnsutils docbook-xml docbook-xsl flex gcc gdb git glusterfs-common gzip heimdal-multidev hostname htop krb5-config krb5-user lcov libacl1-dev libarchive-dev libattr1-dev libavahi-common-dev libblkid-dev libbsd-dev libcap-dev libcephfs-dev libcups2-dev libdbus-1-dev libglib2.0-dev libgnutls28-dev libgpgme11-dev libicu-dev libjansson-dev libjs-jquery libjson-perl libkrb5-dev libldap2-dev liblmdb-dev libncurses5-dev libpam0g-dev libparse-yapp-perl libpcap-dev libpopt-dev libreadline-dev libsystemd-dev libtasn1-bin libtasn1-dev libunwind-dev lmdb-utils locales lsb-release make mawk mingw-w64 patch perl perl-modules pkg-config procps psmisc python3 python3-cryptography python3-dbg python3-dev python3-dnspython python3-gpg python3-iso8601 python3-markdown python3-matplotlib python3-pexpect python3-pyasn1 rsync sed  tar tree uuid-dev wget xfslibs-dev xsltproc zlib1g-dev -y
```

#### Setando e validando o hostname do dc01:

```bash
vim /etc/hostname
```

```bash
dc01
```

```bash
hostname -f
```

#### Configurando o arquivo de hosts:

```bash
vim /etc/hosts
```

```bash
.0.0.1             localhost
127.0.1.1          dc01.esharknet.edu       dc01
192.168.70.150     fileserver.esharknet.edu fileserver
192.168.70.200     dc02.esharknet.edu       dc02
192.168.70.250     dc01.esharknet.edu       dc01
192.168.70.254     firewall.esharknet.edu   firewall
```

#### Setando ip fixo no servidor dc01:

```bash
vim /etc/network/interfaces
```

```bash
iface enp1s0 inet static
address           192.168.70.250
netmask           255.255.255.0
gateway           192.168.70.254
dns-nameserver    192.168.70.254 #(firewall)
dns-search        esharknet.edu
```

#### Setando endereço do firewall como resolvedor externo (temporário até provisionar o domínio):

```bash
vim /etc/resolv.conf
```

```bash
domain             esharknet.edu
search             esharknet.edu.
nameserver         192.168.70.254 #(firewall)
```

#### Validando o ip da placa:

```bash
ip -c addr
```

```bash
ip -br link
```

#### Baixando e compilando o código fonte do Samba4:

```bash
wget https://download.samba.org/pub/samba/samba-4.18.6.tar.gz
```

```bash
tar -xvzf samba-4.18.6.tar.gz
```

```bash
cd samba-4.18.6
```

```bash
./configure --prefix=/opt/samba
```

```bash
make
```

```bash
make install
```

#### Adicionando /opt/Samba ao path padrão do Linux, colando a linha completa ao final do .bashrc:

#### PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/samba/bin:/opt/samba/sbin"

```bash
vim ~/.bashrc
```

```bash
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/samba/bin:/opt/samba/sbin"
```

#### Relendo o arquivo de profile:

```bash
source ~/.bashrc
```

#### Criando o daemon de inicialização do Samba4 com o sistema:

```bash
vim /etc/systemd/system/samba-ad-dc.service
```

```bash
[Unit]
   Description=Samba4 Active Directory Master Domain Controller
   After=network.target remote-fs.target nss-lookup.target

[Service]
   Type=forking
   ExecStart=/opt/samba/sbin/samba -D
   PIDFile=/opt/samba/var/run/samba.pid

[Install]
   WantedBy=multi-user.target
```

```bash
chmod +x /etc/systemd/system/samba-ad-dc.service
```

#### Instalando e editando o serviço de sincronização de horário:

```bash
cp /etc/ntpsec/ntp.conf{,.orig}
```

```bash
vim /etc/ntpsec/ntp.conf
```

```bash
driftfile /var/lib/ntpsec/ntp.drift
leapfile /usr/share/zoneinfo/leap-seconds.list
pool a.ntp.org iburst
pool b.ntp.org iburst
pool 2.debian.pool.ntp.org iburst
pool 3.debian.pool.ntp.org iburst
restrict 127.0.0.1
restrict ::1
tinker panic 0 #(Flag usada SOMENTE em VMs)
```

```bash
systemctl restart ntpd
```

```bash
ntpq -p
```

#### Provisionando o novo domínio suportado pelo dc01:

```bash
samba-tool domain provision --use-rfc2307 --interactive --option=”interfaces=lo enp1s0” --option=”bind interfaces only=yes”
```

#### Habilitando o daemon pra subir no boot do sistema:

```bash
systemctl daemon-reload
```

```bash
systemctl enable samba-ad-dc.service
```

```bash
systemctl start samba-ad-dc.service
```

```bash
systemctl status samba-ad-dc.service
```

#### Linkando o arquivo krb5.conf do Samba4 ao /etc do sistema:

```bash
mv /etc/krb5.conf{,.orig}
```

```bash
ln -sf /opt/samba/private/krb5.conf /etc/krb5.conf
```

#### APÓS o provisionamento da Samba4, precisamos reconfigurar o /etc/resolv.conf e setar o DNS apontando a resolução de nomes para o próprio dc01:

```bash
vim /etc/resolv.conf
```

```bash
domain           esharknet.edu
search           esharknet.edu.
nameserver       127.0.0.1 #(localhost)
```

#### Bloqueando alteração do resolv.conf:

```bash
chattr +i /etc/resolv.conf
```

#### Validando resolvedor de nomes pelo dc01:

```bash
nslookup dc01.esharknet.edu
```

### Vai validar na tela:

```bash
Server:         127.0.0.1
Address:        127.0.0.1#53

Name:   dc01.esharknet.edu
Address: 192.168.70.250
```

#### Reboot do servidor dc01:

```bash
reboot
```

#### Validando os serviços do Samba4 no boot do sistema:

```bash
ps aux | grep samba
```

```bash
ps aux | egrep "samba|smbd|nmbd|winbind"
```

```bash
find / -name samba.pid
```

```bash
pgrep samba
```

#### Dando poderes de root ao Administrator:

```bash
vim /opt/samba/etc/user.map
```

```bash
!root = esharknet.edu\Administrator
```

#### Linkando bibliotecas do Samba4 para mapeamento de usuários no sistema Linux (rode esses comandos manualmente sem copiar e colar):

```bash
/opt/samba/sbin/smbd -b | grep LIBDIR
```

```bash
ln -s /opt/samba/lib/libnss_winbind.so.2 /lib/x86-64-linux-gnu/
```

```bash
ln -s /lib/x86_64-linux-gnu/libnss_winbind.so.2 /lib/x86_64-linux-gnu/libnss_winbind.so
```

```bash
ldconfig
```

#### Validando a autenticação de usuários de rede no sistema Linux mas tbém no winbind:

```bash
vim /etc/nsswitch.conf
```

```bash
passwd: files systemd winbind
group: files systemd winbind
shadow: files
```

#### Editando o arquivo smb.conf e adicionando no dns forwarder, quem resolve nomes para consultas externas (o firewall e o google):

```bash
cp /opt/samba/etc/smb.conf{,.orig}
```

```bash
vim /opt/samba/etc/smb.conf
```

```bash
[global]
      bind interfaces only = Yes
      dns forwarder = 192.168.70.254 8.8.8.8 #(firewall + google)
      interfaces = lo enp1s0
      netbios name = DC01
      realm = ESHARKNET.EDU
      server role = active directory domain controller
      workgroup = ESHARKNET
      idmap_ldb:use rfc2307 = yes

[sysvol]
      path = /opt/samba/var/locks/sysvol
      read only = No

[netlogon]
      path = /opt/samba/var/locks/sysvol/esharknet.edu/scripts
      read only = No
```

#### Relendo a configuração do Samba4:

```bash
smbcontrol all reload-config
```

#### Validando usuários da base do ldap local:

```bash
cat /etc/passwd | grep root
```

#### Validando usuários de rede do Samba4 (Intermediados pelo winbind):

```bash
samba-tool user show administrator
```

```bash
getent passwd administrator
```

```bash
wbinfo -u
```

```bash
wbinfo -g
```

```bash
wbinfo --ping-dc
```

```bash
getent group "Domain Admins"
```

#### Validando daemons ativos:

```bash
ps aux | egrep "samba|smbd|nmbd|winbind"
```

```bash
ps axf
```

#### Consultando serviços do SAMBA4:

```bash
smbclient --version
```

```bash
smbclient -L localhost -U%
```

```bash
smbclient //localhost/netlogon -UAdministrator -c "ls"
```

```bash
testparm
```

```bash
samba-tool domain level show
```

#### Desabilitando complexidade de senhas (inseguro):

```bash
samba-tool domain passwordsettings show
```

```bash
samba-tool domain passwordsettings set --complexity=off
```

```bash
samba-tool domain passwordsettings set --history-length=0
```

```bash
samba-tool domain passwordsettings set --min-pwd-length=0
```

```bash
samba-tool domain passwordsettings set --min-pwd-age=0
```

```bash
samba-tool user setexpiry Administrator --noexpiry
```

#### Relendo as configurações do SAMBA4:

```bash
smbcontrol all reload-config
```

#### Validando a troca de tickets do Kerberos:

```bash
 kinit Administrator@ESHARKNET.EDU
```

```bash
klist 
```

#### Consultando as bases do kerberos, ldap e dns:

```bash
host -t srv _kerberos._tcp.esharknet.edu
```

```bash
host -t srv _ldap._tcp.esharknet.edu
```

```bash
host -t A dc01.esharknet.edu.
```

```bash
dig esharknet.edu
```

zerolies@disroot.org

THAT’S ALL FOLKS!!

# 

# Construindo um Controlador de Domínio secundário com Samba4 no Debian Linux 12

#### Layout de rede usado no laboratório:

```bash
firewall           192.168.70.254 - 192.168.122.254
dc01               192.168.70.250   (ssh 22250)
dc02               192.168.70.200   (ssh 22200)
fileserver         192.168.70.150   (ssh 22150)

firewall           Roteamento por Iptables
dc01               Controlador de Domínio primário
dc02               Controlador de Domínio secundário
fileserver         Servidor de Arquivos
```

#### Instalando as dependências para compilação do código fonte do Samba4:

```bash
export DEBIAN_FRONTEND=noninteractive;apt-get update; apt-get install vim ntp net-tools rsync acl apt-utils attr autoconf bind9utils binutils bison build-essential ntp rsync ccache chrpath curl debhelper dnsutils docbook-xml docbook-xsl flex gcc gdb git glusterfs-common gzip heimdal-multidev hostname htop krb5-config krb5-user lcov libacl1-dev libarchive-dev libattr1-dev libavahi-common-dev libblkid-dev libbsd-dev libcap-dev libcephfs-dev libcups2-dev libdbus-1-dev libglib2.0-dev libgnutls28-dev libgpgme11-dev libicu-dev libjansson-dev libjs-jquery libjson-perl libkrb5-dev libldap2-dev liblmdb-dev libncurses5-dev libpam0g-dev libparse-yapp-perl libpcap-dev libpopt-dev libreadline-dev libsystemd-dev libtasn1-bin libtasn1-dev libunwind-dev lmdb-utils locales lsb-release make mawk mingw-w64 patch perl perl-modules pkg-config procps psmisc python3 python3-cryptography python3-dbg python3-dev python3-dnspython python3-gpg python3-iso8601 python3-markdown python3-matplotlib python3-pexpect python3-pyasn1 rsync sed  tar tree uuid-dev wget xfslibs-dev xsltproc zlib1g-dev -y
```

#### Setando e validando o hostname do dc02:

```bash
vim /etc/hostname
```

```bash
dc02
```

```bash
hostname -f
```

```bash
dc02.esharknet.edu
```

#### Configurando o arquivo de hosts:

```bash
vim /etc/hosts
```

```bash
.0.0.1              localhost
127.0.1.1           dc02.esharknet.edu       dc02
192.168.70.150      fileserver.esharknet.edu fileserver
192.168.70.200      dc02.esharknet.edu       dc02
192.168.70.250      dc01.esharknet.edu       dc01
192.168.70.254      firewall.esharknet.edu   firewall
```

#### Setando ip fixo no servidor dc02:

```bash
vim /etc/network/interfaces
```

```bash
allow-hotplug enp1s0
iface enp1s0 inet static
address           192.168.70.200
netmask           255.255.255.0
gateway           192.168.70.254
```

#### Apontando o endereço do resolvedor de nomes principal da rede pro Controlador de domínio primário, dc01 (temporário, até provisionar):

```bash
vim /etc/resolv.conf
```

```bash
domain           esharknet.edu
search           esharknet.edu.
nameserver       192.168.70.250 #(dc01)
nameserver       127.0.0.1
```

#### Validando a resolução de nomes pelo dc01:

```bash
nslookup esharknet.edu
```

```bash
Server:         192.168.70.250
Address:        192.168.70.250#53

Name:   esharknet.edu
Address: 192.168.70.250
Name:   esharknet.edu
Address: 192.168.70.200
```

#### Relendo as configurações de rede:

```bash
systemctl restart networking
```

#### Validando o ip da placa:

```bash
ip -c addr
```

```bash
ip -br link
```

#### Baixando e compilando o código fonte do Samba4:

```bash
wget https://download.samba.org/pub/samba/samba-4.18.6.tar.gz
```

```bash
tar -xvzf samba-4.18.6.tar.gz
```

```bash
cd samba-4.18.6
```

```bash
./configure --prefix=/opt/samba
```

```bash
make && make install
```

#### Adicionando /opt/Samba ao path padrão do Linux, colando a linha completa ao final do .bashrc:

#### PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/samba/bin:/opt/samba/sbin"

```bash
vim ~/.bashrc
```

```bash
PATH="/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/opt/samba/bin:/opt/samba/sbin"
```

#### Relendo o arquivo de profile:

```bash
source ~/.bashrc
```

#### Criando o daemon de inicialização do Samba4 com o sistema:

```bash
vim /etc/systemd/system/samba-ad-dc.service
```

```bash
[Unit]
   Description=Samba4 Active Directory Slave Domain Controller
   After=network.target remote-fs.target nss-lookup.target

[Service]
   Type=forking
   ExecStart=/opt/samba/sbin/samba -D
   PIDFile=/opt/samba/var/run/samba.pid

[Install]
   WantedBy=multi-user.target
```

```bash
chmod +x /etc/systemd/system/samba-ad-dc.service
```

#### Configurando o serviço de sincronização de horário, apontando pro Controlador de domínio primário, dc01:

```bash
mv /etc/ntpsec/ntp.conf{,.orig}
```

```bash
vim /etc/ntpsec/ntp.conf
```

```bash
driftfile /var/lib/ntpsec/ntp.drift
leapfile /usr/share/zoneinfo/leap-seconds.list
tos minclock 4 minsane 3
pool 192.168.70.250 iburst #(dc01)
restrict default kod nomodify nopeer noquery limited
restrict 127.0.0.1
restrict ::1
tinker panic 0 #(Flag usada SOMENTE em VMs)
```

```bash
systemctl restart ntp
```

```bash
ntpq -p
```

```bash
date
```

As máquinas Windows/Linux, membros do domínio, usarão o DC1 que retém a função FSMO emulador PDC como fonte de tempo padrão!

#### Provisionando o servidor DC02:

```bash
samba-tool domain join ESHARKNET.EDU DC -U Administrator --realm=ESHARKNET.EDU --dns-backend=SAMBA_INTERNAL --option="interfaces=lo enp1s0" --option="bind interfaces only=yes" --option="idmap_ldb:use-rfc2307=yes"
```

#### Habilitando o daemon pra subir no boot do sistema:

```bash
systemctl daemon reload
```

```bash
systemctl enable samba-ad-dc.service
```

```bash
systemctl start samba-ad-dc.service
```

```bash
systemctl status samba-ad-dc.service
```

#### Editando o arquivo do kerberos:

```bash
mv /etc/krb5.conf{,.orig}
```

```bash
vim /etc/krb5.conf
```

```bash
[libdefaults] #(sem espaço no canto dessa linha)
    dns_lookup_realm = false
    dns_lookup_kdc = true
    default_realm = ESHARKNET.EDU
```

#### Visualizando o arquivo smb.conf:

```bash
cat /opt/samba/etc/smb.conf
```

```bash
# Global parameters
[global]
    bind interfaces only = Yes
    interfaces = lo enp1s0
    netbios name = DC02
    realm = ESHARKNET.EDU
    server role = active directory domain controller
    workgroup = ESHARKNET
    idmap_ldb:use-rfc2307 = yes

[sysvol]
    path = /opt/samba/var/locks/sysvol
    read only = No

[netlogon]
    path = /opt/samba/var/locks/sysvol/esharknet.edu/scripts
    read only = No
```

#### Validando as entradas DNS usadas:

```bash
apt install ldb-tools
```

```bash
host -t A esharknet.edu.
```

#### (SE NECESSÁRIO), SE Necessário, adicione as entradas do dc02, manualmente AO DNS do Samba4, no dc01:

```bash
samba-tool dns add dc01 ESHARKNET.EDU dc02 A 192.168.70.200 -U administrator
```

```bash
ldbsearch -H /opt/samba/private/sam.ldb '(invocationId=*)' --cross-ncs objectguid
```

```bash
host -t CNAME df4bdd8c-abc7-4779-b01e-4dd4553ca3e9._msdcs.esharknet.edu.
```

#### SE não rodar, execute a replicação para todos os DCs:

```bash
samba-tool dns add dc01 _msdcs.esharknet.edu df4bdd8c-abc7-4779-b01e-4dd4553ca3e9 CNAME dc02.esharknet.edu -Uadministrator
```

#### PASTA SYSVOL

#### Replicando a pasta sysvol. Mapeando IDs de grupos e usuários para o dc02 (execute estes comando NO DC01):

```bash
tdbbackup -s .bak /opt/samba/private/idmap.ldb
```

```bash
scp -rv -p22200 /opt/samba/private/idmap.ldb.bak root@dc02:/root
```

```bash
scp -rv -p22200 /opt/samba/var/locks/sysvol/* root@dc02:/opt/samba/var/locks/sysvol
```

#### Aplicando o arquivo BD que enviamos do dc01 (execute estes comandos NO DC02):

```bash
mv /root/idmap.ldb.bak /root/idmap.ldb
```

```bash
cp -rfv /root/idmap.ldb /opt/samba/private/
```

```bash
samba-tool ntacl sysvolreset
```

#### Agora precisamos pensar que tendo dois DCs na rede, SE cair o primário o secundário assume o controle, e vice versa. Logicamente devemos apontar um pro outro como resolvedor de nomes primário, ou seja, o dc01 vai resolver primeiro no dc02 e o dc02 vai resolver primeiro no dc01:

#### Edite o /etc/resolv.conf NO DC01 e aponte pro dc02:

```bash
vim /etc/resolv.conf
```

```bash
domain           esharknet.edu
search           esharknet.edu.
nameserver       192.168.70.200 #(dc02)
nameserver       127.0.0.1
```

#### Bloqueando a edição do arquivo resolv.conf:

```bash
chattr +i /etc/resolv.conf
```

#### E no reverso, edite o /etc/resolv.conf NO DC02 apontando pro dc01:

#### Desbloqueando a edição do arquivo resolv.conf:

```bash
chattr -i /etc/resolv.conf
```

```bash
vim /etc/resolv.conf
```

```bash
domain           esharknet.edu
search           esharknet.edu.
nameserver       192.168.70.250 #(dc01)
nameserver       127.0.0.1
```

#### Bloqueando a edição do arquivo resolv.conf:

```bash
chattr +i /etc/resolv.conf
```

#### Validando a replicação ( execute em todos os DCs):

```bash
samba-tool drs showrepl
```

#### Criando um usuário no dc01 (execute NO DC01):

```bash
samba-tool user create userteste
```

```bash
samba-tool user list
```

#### Validando no dc02, se consta o usuário criado no dc01 (execute NO DC02):

```bash
samba-tool user list
```

#### Validando o compartilhamento padrão:

```bash
smbclient -L localhost -U%
```

```bash
smbclient //localhost/netlogon -UAdministrator -c 'ls'
```

#### Validando o DNS local:

```bash
host -t A esharknet.edu localhost
```

#### Validando a troca de tickets do kerberos:

```bash
kinit Administrator
```

```bash
klist
```

#### Validando configuração de kerberos e ldap:

```bash
host -t srv _kerberos._tcp.esharknet.edu
```

```bash
host -t srv _ldap._tcp.esharknet.edu
```

```bash
dig esharknet.edu
```

```bash
host -t A <máquina do domínio>
```

#### Validando informações de servidor qual controla o PDC Emulator:

```bash
samba-tool fsmo show | grep -i pdc
```

```bash
samba-tool fsmo show
```

#### Validando a localização do diretório 'sysvol' do dc01:

```bash
uname -ra
```

```bash
find /opt/samba -iname sysvol
```

```bash
     /opt/samba/var/locks/sysvol
```

#### Validando espaço disponível:

```bash
df -h
```

#### Validando a UUID do seu disco:

```bash
blkid /dev/sda2 #(Sete A SUA partição de disco)
```

#### Validando suporte ativo no Kernel ás flags de acl e segurança:

```bash
cat /boot/config-6.4.0-3-amd64 | grep _ACL
```

```bash
cat /boot/config-6.4.0-3-amd64 | grep FS_SECURITY
```

#### Gerando e enviando as chaves do ssh para sincronização entre o dc01 e o dc02 (crie as chaves NO DC01 e envie a chave pública para o dc02):

#### (Pode deixar a senha em branco SE preferir)

```bash
ssh-keygen -t rsa -b 1024
```

```bash
ssh-copy-id -p22200 -i ~/.ssh/id_rsa.pub root@dc02 #(O MEU dc02 usa a porta ssh 22200)
```

#### Testando a conexão por ssh sem pedir senha (SE vc deixou em branco):

```bash
ssh -p22200 dc02
```

```bash
exit
```

#### Agora inverta a ordem e crie as chaves NO DC02 e envie para o dc01 (Rode estes comandos NO DC02):

```bash
ssh-keygen -t rsa -b 1024
```

```bash
ssh-copy-id -p22250 -i ~/.ssh/id_rsa.pub root@dc01 #(enviando para o dc01, que usa porta ssh 22250)
```

#### Testando a conexão por ssh sem pedir senha (SE vc deixou em branco):

```bash
ssh -p22250 dc01
```

```bash
exit
```

#### Criando script de sincronização com rsync do diretório 'sysvol' DO DC01 para envio ao dc02 (rode estes comando NO DC01):

```bash
cd /opt
```

```bash
vim rsync-sysvol.sh
```

```bash
#!/bin/bash
# Sincronizando Diretorios do Sysvol do dc01 para envio ao dc02:
#rsync -Cravz /opt/samba/var/locks/sysvol/*  root@192.168.70.200:/opt/samba/var/locks/sysvol/
# no MEU CASO onde a porta do ssh não á a default. MEU dc02 usa 22200:
rsync -Cravz -e "ssh -p 22200" /opt/samba/var/locks/sysvol/*  root@192.168.70.200:/opt/samba/var/locks/sysvol/
```

```bash
chmod +x rsync-sysvol
```

```bash
./rsync-sysvol
```

#### Agendando a sincronização no cron do dc01:

```bash
crontab -e
```

```bash
*/5 * * * * root  bash /opt/rsync-sysvol.sh --silent
```

#### REPITA o processo de replicação do sysvol, agora NO DC02, INVERTENDO os apontamentos de ip, obviamente!

#### Criando script de sincronização do diretório 'sysvol' DO DC02 para envio ao dc01 (rode os comando agora NO DC02):

```bash
cd /opt
```

```bash
vim rsync-sysvol.sh
```

```bash
#!/bin/bash
# Sincronizando Diretorios do Sysvol do dc01 para envio ao dc02:
#rsync -Cravz /opt/samba/var/locks/sysvol/*  root@192.168.70.250:/opt/samba/var/locks/sysvol/
# no MEU CASO onde a porta do ssh não á a default. MEU dc01 usa 22250:
rsync -Cravz -e "ssh -p 22250" /opt/samba/var/locks/sysvol/*  root@192.168.70.250:/opt/samba/var/locks/sysvol/
```

```bash
chmod +x rsync-sysvol
```

```bash
./rsync-sysvol
```

#### Agendando a sincronização no cron do dc02:

```bash
crontab -e
```

```bash
*/5 * * * * root  bash /opt/rsync-sysvol.sh --silent
```

#### As Estações de trabalho, usarão, como DNS primário o PDC Emulator do Domínio, e como DNS secundário o PDC Secundário da rede.

#### OSYNC

#### Configurando a sincronização da pasta sysvol com osync, que vai espelhar os DCs (rode esses comandos NO DC01, primeiro):

```bash
cd /opt
```

```bash
git clone https://github.com/deajan/osync.git
```

```bash
cd osync
```

```bash
sh ./install.sh
```

#### Vai criar o diretório /etc/osync:

#### Dentro dele vai ter o arquivo de configuração sync.conf.example. Crie um arquivo sync.conf e cole o conteúdo abaixo:

```bash
vim /etc/osync/sync.conf
```

```bash
#!/usr/bin/env bash

INSTANCE_ID="sysvol_sync"

INITIATOR_SYNC_DIR="/opt/samba/var/locks/sysvol"

TARGET_SYNC_DIR="ssh://root@192.168.70.200:22200//opt/samba/var/locks/sysvol"

SSH_RSA_PRIVATE_KEY="/root/.ssh/id_rsa"

REMOTE_3RD_PARTY_HOSTS=""

PRESERVE_ACL=yes

PRESERVE_XATTR=yes

SOFT_DELETE=yes

DESTINATION_MAILS="roor@localhost"

#REMOTE_RUN_AFTER_CMD="/opt/samba/bin/samba-tool ntacl sysvolreset"
```

#### rodando o script de atualização, que está dentro do /opt/osync, apontando pro arquivo /etc/osync/sync.conf:

```bash
./upgrade-v1.0x-v1.2x.sh /etc/osync/sync.conf
```

#### Vai ficar semelhante ao modelo abaixo:

```bash
#!/usr/bin/env bash

INSTANCE_ID="sysvol_sync"

INITIATOR_SYNC_DIR="/opt/samba/var/locks/sysvol"

TARGET_SYNC_DIR="ssh://root@192.168.70.200:22200//opt/samba/var/locks/sysvol"

SSH_RSA_PRIVATE_KEY="/root/.ssh/id_rsa"

SSH_PASSWORD_FILE=""

_REMOTE_TOKEN="SomeAlphaNumericToken9"

CREATE_DIRS=false

LOGFILE=""

MINIMUM_SPACE="10240"

BANDWIDTH="0"

SUDO_EXEC=false

RSYNC_EXECUTABLE="rsync"

RSYNC_REMOTE_PATH=""

RSYNC_PATTERN_FIRST="include"

RSYNC_INCLUDE_PATTERN=""

RSYNC_EXCLUDE_PATTERN=""

RSYNC_INCLUDE_FROM=""

RSYNC_EXCLUDE_FROM=""

PATH_SEPARATOR_CHAR=";"

SSH_COMPRESSION=true

SSH_IGNORE_KNOWN_HOSTS=false

SSH_CONTROLMASTER=false

REMOTE_HOST_PING=false
```

#### Testando o sincronizmo (ignore o erro de email):

```bash
/usr/local/bin/osync.sh /etc/osync/sync.conf --dry --verbose
```

#### Rodar o sincronizmo de fato:

```bash
/usr/local/bin/osync.sh /etc/osync/sync.conf --verbose
```

#### Agendar no cron:

```bash
crontab -e
```

```bash
*/5 * * * * root  bash /usr/local/bin/osync.sh /etc/osync/sync.conf --silent
```

#### Validando os logs em tempo real, rode o /usr/local/bin/osync.sh, mantendo outro terminal aberto com o comando:

```bash
tail -f /var/log/osync.sysvol_sync.log
```

#### INVERTENDO a sincronização com o Osync, vamos refazer tudo, incluíndo o ip e porta ssh, agora NO DC02:

```bash
cd /opt
```

```bash
git clone https://github.com/deajan/osync.git
```

```bash
cd osync
```

```bash
sh ./install.sh
```

#### Vai criar o diretório /etc/osync:

#### Dentro dele vai ter o arquivo de configuração sync.conf.example. Crie um arquivo sync.conf e cole o conteúdo abaixo:

```bash
#!/usr/bin/env bash

INSTANCE_ID="sysvol_sync"

INITIATOR_SYNC_DIR="/opt/samba/var/locks/sysvol"

TARGET_SYNC_DIR="ssh://root@192.168.70.250:22250//opt/samba/var/locks/sysvol"

SSH_RSA_PRIVATE_KEY="/root/.ssh/id_rsa"

REMOTE_3RD_PARTY_HOSTS=""

PRESERVE_ACL=yes

PRESERVE_XATTR=yes

SOFT_DELETE=yes

DESTINATION_MAILS="roor@localhost"

#REMOTE_RUN_AFTER_CMD="/opt/samba/bin/samba-tool ntacl sysvolreset"
```

#### Vai precisa configurar seu ip e o path pra rodar o script de atualização, apontando pro arquivo sync.conf:

```bash
./upgrade-v1.0x-v1.2x.sh /etc/osync/sync.conf
```

#### Vai ficar semelhante ao modelo abaixo:

```bash
#!/usr/bin/env bash

INSTANCE_ID="sysvol_sync"

INITIATOR_SYNC_DIR="/opt/samba/var/locks/sysvol"

TARGET_SYNC_DIR="ssh://root@192.168.70.250:22250//opt/samba/var/locks/sysvol"

SSH_RSA_PRIVATE_KEY="/root/.ssh/id_rsa"

SSH_PASSWORD_FILE=""

_REMOTE_TOKEN="SomeAlphaNumericToken9"

CREATE_DIRS=false

LOGFILE=""

MINIMUM_SPACE="10240"

BANDWIDTH="0"

SUDO_EXEC=false

RSYNC_EXECUTABLE="rsync"

RSYNC_REMOTE_PATH=""

RSYNC_PATTERN_FIRST="include"

RSYNC_INCLUDE_PATTERN=""

RSYNC_EXCLUDE_PATTERN=""

RSYNC_INCLUDE_FROM=""

RSYNC_EXCLUDE_FROM=""

PATH_SEPARATOR_CHAR=";"

SSH_COMPRESSION=true

SSH_IGNORE_KNOWN_HOSTS=false

SSH_CONTROLMASTER=false

REMOTE_HOST_PING=false
```

#### Testar o sincronizmo (ignore o erro de email):

```bash
/usr/local/bin/osync.sh /etc/osync/sync.conf --dry --verbose
```

#### Rodar o sincronizmo de fato:

```bash
/usr/local/bin/osync.sh /etc/osync/sync.conf --verbose
```

#### Agendar no cron:

```bash
crontab -e
```

```bash
*/5 * * * * root  bash /usr/local/bin/osync.sh /etc/osync/sync.conf --silent
```

#### Validando os logs em tempo real, rode o /usr/local/bin/osync.sh, mantendo outro terminal aberto com o comando:

```bash
tail -f /var/log/osync.sysvol_sync.log
```

zerolies@disroot.org

THAT’S ALL FOLKS!!
